<?php
	include_once("connect.php");
			
	class login
	{
			
			////////////////////////////////////////////////////////////////////////
			////////////////////////////////////////////////////////////////////////
			////////////////////////////////////////////////////////////////////////
		
			public function __construct()
			{
				Connect::getConnect();
				
			}
			
			
			////////////////////////////////////////////////////////////////////////
			////////////////////////////////////////////////////////////////////////
			////////////////////////////////////////////////////////////////////////

			public function logUser()
			{
					
					$user_name=$this->getUser();
					$ip=$this->getIp();
						
					$sql="insert into login_info values(NULL,'$user_name','$ip',now(),NULL)";				
					$ann=mysql_query($sql) or die(" Error : ".mysql_error());
					
			}
			////////////////////////////////////////////////////////////////////////
			////////////////////////////////////////////////////////////////////////
			////////////////////////////////////////////////////////////////////////

			public function logoutUser()
			{
					$lid=$this->getlogid();
					
					$sql="update login_info set outtime=now() where id ='$lid'";				
					$ann=mysql_query($sql) or die(" Error : ".mysql_error());
					
					
			}
			
		
		
		
			////////////////////////////////////////////////////////////////////////
			////////////////////////////////////////////////////////////////////////
			////////////////////////////////////////////////////////////////////////

		  
		    public function getIp()
			{
		
			return getenv('REMOTE_ADDR');
			}
			
			////////////////////////////////////////////////////////////////////////
			////////////////////////////////////////////////////////////////////////
			////////////////////////////////////////////////////////////////////////


	  
		    public function getmaxid()
			{
			
			$user_name=$this->getUser();
			
		    $query22="select max(id) as mid from login_info where user_id='$user_name'";
			$data222=mysql_query($query22);
			while($predata=mysql_fetch_array($data222)){
			return $predata['mid'];
			}
			}
			
			////////////////////////////////////////////////////////////////////////
			////////////////////////////////////////////////////////////////////////
			////////////////////////////////////////////////////////////////////////
			
			

		  
		    public function getlogid()
			{
		    $lid=$_SESSION['login_id'];
			return $lid;
			}
			
			////////////////////////////////////////////////////////////////////////
			////////////////////////////////////////////////////////////////////////
			////////////////////////////////////////////////////////////////////////
	
	
		    public function getUser()
			{
			$user_name=$_SESSION['user_id'];
			return $user_name;
			}
			
			////////////////////////////////////////////////////////////////////////
			////////////////////////////////////////////////////////////////////////
			////////////////////////////////////////////////////////////////////////


			public function last_login()
			{
			
			$time_diff=15;
			
			$sql="select distinct l.user_id as user, concat(u.l_name,' ',u.initials) as name, minute(timediff(now(), l.intime)) as 	minute from login_info l, users u where l.user_id=u.user and (minute(timediff(now(), l.intime))<'$time_diff') group by l.intime desc limit 10";
			
			$data2=mysql_query($sql);
			echo '<table border=0>';			
			while($data=mysql_fetch_array($data2)){
			echo "<tr>";
			$image_url="images/std_pics/".$data['user'].".jpg";
			if(file_exists($image_url))
			echo "<td rowspan=2 width=32px><img src=images/std_pics/".$data['user'].".jpg width=30px height=30px>";
			else
			echo "<td rowspan=2 width=32px><img src=images/std_pics/no_picture.jpg width=30px height=30px>";
			echo "<td><font size=1.5px color=#454877>".$data['name']."</font><tr>";
			echo "<td><font size=1.5px color=#f47854>".$data['minute']." Minutes ago </font>";
			echo "</tr>";
			}
			echo '</table>';
			}

			
			
	}
?>
